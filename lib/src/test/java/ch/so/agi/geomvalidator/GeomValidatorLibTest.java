package ch.so.agi.geomvalidator;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import static org.junit.jupiter.api.Assertions.*;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;

public class GeomValidatorLibTest {
    Logger logger = LoggerFactory.getLogger(GeomValidatorLibTest.class);
    
    ByteArrayOutputStream baos;
    PrintStream old;
    
    @BeforeEach
    public void initEach(){
        baos = new ByteArrayOutputStream();
        PrintStream ps = new PrintStream(baos);
        old = System.out;
        System.setErr(ps);

    }
    
    @AfterEach
    public void cleanUpEach(){
        System.err.flush();
        System.setErr(old);
    }
    
    @Test
    @DisplayName("Find duplicate coords in polygon")
    public void validate_Fail_Polygon_Duplicate_Coords() {
        //String wktGeom = "POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))";
        //String wktGeom = "MultiPolygon (((2609000 1236700, 2609200 1236700, 2609200 1236600, 2609000 1236600, 2609000 1236700)))";
        String wktGeom = "POLYGON ((2609000 1236700, 2609200 1236700, 2609200 1236700, 2609200 1236600, 2609000 1236600, 2609000 1236700))";
        int result = GeomValidatorLib.validate("alayer", "f1", wktGeom);
        
        assertTrue(baos.toString().contains("duplicate coord at (2609200.0, 1236700.0, NaN)"));
    }
    
    @Test
    @DisplayName("Valid polygon")
    public void validate_Ok_Polygon() {
        String wktGeom = "POLYGON ((2609000 1236700, 2609200 1236700, 2609200 1236600, 2609000 1236600, 2609000 1236700))";
        int result = GeomValidatorLib.validate("alayer", "f1", wktGeom);
        
        assertTrue(baos.toString().length() == 0);
    }
    
    @Test
    @DisplayName("Find intersection in polygon")
    public void validate_Fail_Polygon_Intersection() {
        //String wktGeom = "MULTIPOLYGON (((2609175.91285087121650577 1236899.55443738773465157, 2609178.72295488230884075 1236905.70437195850536227, 2609177.94245307194069028 1236909.95406916970387101, 2609190.71932489424943924 1236843.16401896486058831, 2609168.87400558451190591 1236833.00159565173089504, 2609144.28793872706592083 1236823.08061243919655681, 2609132.18605001177638769 1236817.7022102102637291, 2609125.37332219816744328 1236812.48679124726913869, 2609112.01612087897956371 1236800.89452804950997233, 2609100.10861304774880409 1236792.35171759780496359, 2609088.14115451788529754 1236785.22849048348143697, 2609067.24560165219008923 1236773.45143266767263412, 2609053.37858525430783629 1236767.8478715387172997, 2609040.27143141534179449 1236764.33381766802631319, 2609030.58353419462218881 1236761.67453136458061635, 2609020.57960325013846159 1236758.53957212041132152, 2609004.55910542141646147 1236749.23267884459346533, 2608997.7205699821934104 1236746.00349658285267651, 2608992.49670952092856169 1236744.95879103918559849, 2608987.63558049453422427 1236744.42127794912084937, 2608984.27399603929370642 1236746.43825720576569438, 2608984.27405497897416353 1236750.47214897815138102, 2608986.51321825059130788 1236757.68589513725601137, 2608990.88238563807681203 1236766.80373453488573432, 2608993.19409407721832395 1236770.25086073554120958, 2608995.63593447906896472 1236766.39421138167381287, 2609004.04971591848880053 1236764.48913565976545215, 2609011.74929476622492075 1236774.72839229414239526, 2609020.95695473067462444 1236781.2370242360047996, 2609027.06876724865287542 1236774.0138681442476809, 2609033.10129930917173624 1236773.29943618457764387, 2609038.18146846769377589 1236782.42747337371110916, 2609036.3559059901162982 1236787.58684536721557379, 2609043.57913638325408101 1236791.31738338526338339, 2609046.00950879883021116 1236798.04650772409513593, 2609043.89679750613868237 1236802.1917106993496418, 2609052.31074594985693693 1236811.71658816817216575, 2609053.73964750394225121 1236821.40028432756662369, 2609049.13592769857496023 1236825.68656247528269887, 2609040.64275214495137334 1236826.32164418650791049, 2609032.38758265413343906 1236818.70175733999349177, 2609031.91150789987295866 1236830.92546200845390558, 2609028.41915262024849653 1236842.51419921801425517, 2609018.97344136238098145 1236841.16492351167835295, 2609016.43297268031165004 1236851.3338524135760963, 2609015.20251454133540392 1236860.05923511483706534, 2609015.38846730999648571 1236869.37967243185266852, 2609018.80789600685238838 1236882.01170524233020842, 2609021.79814832611009479 1236892.29834210709668696, 2609021.92621347215026617 1236893.00263836444355547, 2609042.09590684669092298 1236893.67475343658588827, 2609043.63263392029330134 1236893.77078051236458123, 2609045.45744218584150076 1236888.29617718537338078, 2609045.61507218331098557 1236885.93123368103988469, 2609045.78086699033156037 1236883.44379248307086527, 2609046.12961762072518468 1236878.21144108125008643, 2609047.4740372565574944 1236862.74817593907937407, 2609048.04774251580238342 1236861.17043496202677488, 2609050.19163056602701545 1236859.37593063549138606, 2609051.7217835895717144 1236850.29493597545661032, 2609051.10025625117123127 1236847.72434634272940457, 2609051.45576609298586845 1236846.19901228579692543, 2609053.60999871417880058 1236839.68419359507970512, 2609054.04442079365253448 1236835.09225036134012043, 2609054.80421812925487757 1236832.71779418038204312, 2609060.21789227379485965 1236823.88479150482453406, 2609060.78689000755548477 1236816.76265342719852924, 2609054.86886097071692348 1236812.99677066574804485, 2609054.28676067292690277 1236810.24042422045022249, 2609052.33430053340271115 1236800.99518489371985197, 2609052.18060934450477362 1236788.79634164134040475, 2609059.55062352772802114 1236787.22627806151285768, 2609066.97038622573018074 1236793.49950696551240981, 2609069.61193129559978843 1236803.53668290469795465, 2609074.84443956287577748 1236808.87813091510906816, 2609079.93807048629969358 1236824.13976954016834497, 2609080.14547520130872726 1236833.56856745784170926, 2609076.98993796203285456 1236847.77688631089404225, 2609075.01190293021500111 1236865.40149775007739663, 2609075.03491001296788454 1236866.12013273267075419, 2609075.37175671523436904 1236876.64166752155870199, 2609078.40386041579768062 1236882.17504214821383357, 2609085.88783766515552998 1236888.23871301184408367, 2609087.75209204852581024 1236892.33987663383595645, 2609089.80234160833060741 1236894.38532375544309616, 2609090.03233151603490114 1236893.61532617174088955, 2609090.87229425180703402 1236890.77533516613766551, 2609085.53217062959447503 1236884.1554285790771246, 2609084.05203649774193764 1236875.4854961852543056, 2609090.03199078748002648 1236870.29546849732287228, 2609096.1720256581902504 1236870.56540589779615402, 2609103.15209558978676796 1236872.94532208144664764, 2609111.04227749584242702 1236882.67518437397666276, 2609120.19228501012548804 1236880.03510965406894684, 2609127.88238993193954229 1236884.5650056682061404, 2609131.41243342729285359 1236886.32495988416485488, 2609141.25254099583253264 1236890.29483797284774482, 2609144.37267272220924497 1236898.23475854168646038, 2609154.22267207317054272 1236894.79468175559304655, 2609152.52256926940754056 1236888.34473799681290984, 2609154.06248965207487345 1236882.36475920607335865, 2609161.99248707666993141 1236879.45469824504107237, 2609171.41257543489336967 1236882.25458764377981424, 2609177.13268387597054243 1236887.70449759904295206, 2609177.50280715664848685 1236896.0144432089291513, 2609175.91285087121650577 1236899.55443738773465157),(2609164.77206567116081715 1236849.65485252183862031, 2609171.85231742914766073 1236864.44469197327271104, 2609167.00242902897298336 1236873.75468329899013042, 2609124.85222140047699213 1236874.07509976881556213, 2609104.89208243787288666 1236871.44531396310776472, 2609090.17193158715963364 1236866.19549213023856282, 2609091.45155113516375422 1236839.71564103523269296, 2609095.98124052863568068 1236816.89573534019291401, 2609105.76123748207464814 1236813.31566010322421789, 2609123.10166408866643906 1236836.53534625377506018, 2609133.76181304547935724 1236843.05520063918083906, 2609141.07173955161124468 1236835.50517415162175894, 2609149.42179198330268264 1236836.21508692810311913, 2609165.09195930790156126 1236842.2648944475222379, 2609164.77206567116081715 1236849.65485252183862031)),((2609177.91150908311828971 1236910.11582633666694164, 2609177.91301523707807064 1236910.11435308447107673, 2609177.94245307194069028 1236909.95406916970387101, 2609177.93594679562374949 1236909.9880801965482533, 2609177.91150908311828971 1236910.11582633666694164)),((2609177.91150908311828971 1236910.11582633666694164, 2609172.42306604515761137 1236915.48437480977736413, 2609160.09302176628261805 1236916.70448976382613182, 2609152.68312500137835741 1236926.32450461061671376, 2609143.06304279528558254 1236924.01461420673877001, 2609134.15293991100043058 1236920.04472688562236726, 2609132.80281330086290836 1236911.84479033341631293, 2609126.20286860037595034 1236917.90481886616908014, 2609136.96739237476140261 1236931.11420092615298927, 2609145.16984255751594901 1236930.74128476157784462, 2609164.18490933580324054 1236950.12850242527201772, 2609161.01932477252557874 1236953.61069404520094395, 2609168.28276386857032776 1236960.44930273061618209, 2609177.91150908311828971 1236910.11582633666694164)))";
        String wktGeom = "Polygon ((2616213.43277875427156687 1241179.84635371039621532, 2616206.81819541426375508 1241179.18489537644200027, 2616198.88069540588185191 1241176.53906204039230943, 2616193.58902873378247023 1241159.34114535595290363, 2616216.7400704245083034 1241154.04947868385352194, 2616226.00048710033297539 1241140.15885366965085268, 2616234.58699999982491136 1241111.71900000004097819, 2616326.54215387022122741 1241101.2981765465810895, 2616333.15673721022903919 1241096.17187445797026157, 2616342.56499999994412065 1241102.09400000004097819, 2616348.52999999979510903 1241121.29799999995157123, 2616377.61899999994784594 1241118.6340000000782311, 2616381.3080000001937151 1241121.60700000007636845, 2616522.416503029409796 1241079.96614527469500899, 2616523.86400000005960464 1241079.64100000006146729, 2616542.01220617443323135 1241074.67447860259562731, 2616551.93408118514344096 1241102.70377550646662712, 2616520.18408115254715085 1241149.00585888721980155, 2616538.70491450512781739 1241199.27669227193109691, 2616539.36637283908203244 1241210.52148395008407533, 2616520.51481031952425838 1241226.39648396638222039, 2616510.42100000008940697 1241228.55199999990873039, 2616515.21100000012665987 1241222.38599999994039536, 2616524.77600000007078052 1241217.66400000010617077, 2616522.57299999985843897 1241200.60299999988637865, 2616495.96900000004097819 1241150.05099999997764826, 2616532.98100000014528632 1241105.62400000006891787, 2616523.86400000005960464 1241079.64100000006146729, 2616382.31135965697467327 1241121.30729115032590926, 2616381.3080000001937151 1241121.60700000007636845, 2616378.63199767377227545 1241125.27604115451686084, 2616374.20849506510421634 1241126.10286407195962965, 2616364.14192604506388307 1241124.53190052858553827, 2616350.70605363510549068 1241127.8391921988222748, 2616335.07910049427300692 1241123.66373646515421569, 2616327.65836481004953384 1241113.32844999642111361, 2616326.54215387161821127 1241101.4221999840810895, 2616257.52311083301901817 1241109.1529942627530545, 2616243.01236863061785698 1241146.18432568083517253, 2616231.76757695246487856 1241165.53198195085860789, 2616213.43277875427156687 1241179.84635371039621532))";
        int result = GeomValidatorLib.validate("alayer", "f1", wktGeom);
        
        assertTrue(baos.toString().contains("Intersection coord1 (2616387,162, 1241119,880), tids f1, f1"));
    }
    
    
}
